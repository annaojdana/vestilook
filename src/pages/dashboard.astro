---
import Layout from "../layouts/Layout.astro";
import DashboardView from "../components/dashboard/DashboardView";
import { checkAuth } from "../middleware";
import type { ProfileResponseDto, QuotaSummaryResponseDto } from "../types";

const authResult = await checkAuth(Astro.request);

if ("redirect" in authResult) {
  return authResult.redirect;
}

const { session } = authResult;

const profileResponse = await fetch("/api/profile", {
  headers: {
    Authorization: `Bearer ${session.session.access_token}`,
  },
});

if (profileResponse.status === 204) {
  return Astro.redirect("/onboarding/consent");
}

const profile: ProfileResponseDto = await profileResponse.json();

const quotaResponse = await fetch("/api/profile/quota", {
  headers: {
    Authorization: `Bearer ${session.session.access_token}`,
  },
});

const quota: QuotaSummaryResponseDto = await quotaResponse.json();

---

<Layout title="Dashboard">
  <main>
    <DashboardView client:load profile={profile} quota={quota} />
  </main>
</Layout>
