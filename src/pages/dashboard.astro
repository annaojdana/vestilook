---
import Layout from "../layouts/Layout.astro";
import DashboardView from "../components/dashboard/DashboardView";
import type { ProfileResponseDto, QuotaSummaryResponseDto } from "../types";

/**
 * Dashboard Page - Protected Route
 * Authentication is handled by middleware (src/middleware/index.ts)
 * User must be authenticated to access this page
 */

// Get user from middleware - if null, middleware would have already redirected
const { user, supabase } = Astro.locals;

// Additional safeguard (middleware should prevent this)
if (!user) {
  return Astro.redirect("/auth/login");
}

// Get session for API calls
const { data: { session } } = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect("/auth/login");
}

// Fetch user profile
const profileResponse = await fetch("/api/profile", {
  headers: {
    Authorization: `Bearer ${session.access_token}`,
  },
});

// Redirect to onboarding if profile not completed
if (profileResponse.status === 204) {
  return Astro.redirect("/onboarding/consent");
}

const profile: ProfileResponseDto = await profileResponse.json();

// Fetch quota information
const quotaResponse = await fetch("/api/profile/quota", {
  headers: {
    Authorization: `Bearer ${session.access_token}`,
  },
});

const quota: QuotaSummaryResponseDto = await quotaResponse.json();

---

<Layout title="Dashboard">
  <main>
    <DashboardView client:load profile={profile} quota={quota} />
  </main>
</Layout>
