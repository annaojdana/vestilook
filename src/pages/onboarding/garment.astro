---
import type { SupabaseClient } from "@supabase/supabase-js";

import OnboardingGarmentShell from "../../components/onboarding/OnboardingGarmentShell.tsx";
import OnboardingLayout from "../../layouts/OnboardingLayout.astro";
import type { ImageValidationConstraints, ProfileResponseDto } from "../../types.ts";

interface PrefetchResult {
  profile: ProfileResponseDto | null;
  accessToken: string | null;
  status: number | null;
}

async function prefetchProfile(supabase: SupabaseClient | null): Promise<PrefetchResult> {
  if (!supabase) {
    return { profile: null, accessToken: null, status: 401 };
  }

  const sessionResult = await supabase.auth.getSession();
  const accessToken = sessionResult.data.session?.access_token ?? null;

  if (!accessToken) {
    return { profile: null, accessToken: null, status: 401 };
  }

  try {
    const profileUrl = new URL("/api/profile", Astro.url);
    const response = await fetch(profileUrl, {
      headers: {
        Authorization: `Bearer ${accessToken}`,
      },
    });

    if (response.status === 204) {
      return { profile: null, accessToken, status: 204 };
    }

    if (!response.ok) {
      console.warn("[onboarding/garment] Failed to prefetch profile payload.", {
        status: response.status,
      });
      return { profile: null, accessToken, status: response.status };
    }

    const payload = (await response.json()) as ProfileResponseDto;
    return { profile: payload, accessToken, status: response.status };
  } catch (error) {
    console.error("[onboarding/garment] Prefetch profile request failed.", error);
    return { profile: null, accessToken, status: null };
  }
}

function resolveGarmentConstraints(): ImageValidationConstraints {
  const maxBytes = parseIntegerEnv(import.meta.env.PRIVATE_VTON_MAX_GARMENT_BYTES, 7_340_032);
  const minWidth = parseIntegerEnv(import.meta.env.PRIVATE_VTON_MIN_GARMENT_WIDTH, 1024);
  const minHeight = parseIntegerEnv(import.meta.env.PRIVATE_VTON_MIN_GARMENT_HEIGHT, 1024);
  const allowedMimeRaw = import.meta.env.PRIVATE_VTON_ALLOWED_GARMENT_MIME ?? "image/jpeg,image/png";
  const allowedMimeTypes = allowedMimeRaw
    .split(",")
    .map((value) => value.trim())
    .filter(Boolean);

  return {
    maxBytes,
    minWidth,
    minHeight,
    allowedMimeTypes: allowedMimeTypes.length > 0 ? allowedMimeTypes : ["image/jpeg", "image/png"],
  };
}

function parseIntegerEnv(value: unknown, fallback: number): number {
  if (typeof value === "number" && Number.isFinite(value)) {
    return Math.floor(value);
  }

  if (typeof value === "string") {
    const parsed = Number.parseInt(value, 10);
    if (Number.isFinite(parsed)) {
      return parsed;
    }
  }

  return fallback;
}

function buildLoginRedirect(targetPath: string) {
  const loginPath = import.meta.env.PUBLIC_AUTH_LOGIN_PATH ?? "/auth/login";
  const redirectParam = encodeURIComponent(targetPath);
  return `${loginPath}?redirect=${redirectParam}`;
}

const prefetch = await prefetchProfile(Astro.locals.supabase ?? null);
const constraints = resolveGarmentConstraints();
const personaBucket = import.meta.env.PRIVATE_VTON_PERSONA_BUCKET ?? "vestilook-personas";
const retainOptions = [24, 48, 72];
const defaultRetention = 48;
const nextPath = "/generations/new";
const canonical = Astro.site ? new URL(Astro.url.pathname, Astro.site).href : undefined;

if (prefetch.status === 401 || prefetch.status === 403) {
  return Astro.redirect(buildLoginRedirect(Astro.url.pathname));
}

if (!prefetch.profile || !prefetch.profile.persona) {
  return Astro.redirect("/onboarding/persona");
}

const resolvedProfile = prefetch.profile;
---

<OnboardingLayout
  title="Vestilook — Przygotuj ubranie do try-on"
  description="Ostatni krok przed wygenerowaniem stylizacji: checklistę jakości i wybór retencji wyników znajdziesz poniżej."
  canonical={canonical}
>
  <div class="flex flex-1 flex-col items-center justify-center bg-gradient-to-br from-background via-muted/20 to-primary/5 px-6 py-12">
    <div class="relative z-10 flex w-full max-w-5xl flex-1 items-stretch justify-center">
      <OnboardingGarmentShell
        client:load
        profile={resolvedProfile}
        constraints={constraints}
        personaBucket={personaBucket}
        retainOptions={retainOptions}
        defaultRetention={defaultRetention}
        nextPath={nextPath}
      />
    </div>
  </div>
</OnboardingLayout>
