---
import type { SupabaseClient } from "@supabase/supabase-js";
import OnboardingLayout from "../../layouts/OnboardingLayout.astro";
import OnboardingPersonaShell from "../../components/onboarding/OnboardingPersonaShell.tsx";
import type { ProfileResponseDto } from "../../types.ts";

interface PrefetchResult {
  profile: ProfileResponseDto | null;
  accessToken: string | null;
}

async function prefetchProfile(supabase: SupabaseClient | null): Promise<PrefetchResult> {
  if (!supabase) {
    return { profile: null, accessToken: null };
  }

  const sessionResult = await supabase.auth.getSession();
  const accessToken = sessionResult.data.session?.access_token ?? null;

  if (!accessToken) {
    return { profile: null, accessToken: null };
  }

  try {
    const profileUrl = new URL("/api/profile", Astro.url);
    const response = await fetch(profileUrl, {
      headers: {
        Authorization: `Bearer ${accessToken}`,
      },
    });

    if (!response.ok) {
      console.warn("[onboarding/persona] Failed to prefetch profile payload.", {
        status: response.status,
      });
      return { profile: null, accessToken };
    }

    const payload = (await response.json()) as ProfileResponseDto;
    return { profile: payload, accessToken };
  } catch (error) {
    console.error("[onboarding/persona] Prefetch profile request failed.", error);
    return { profile: null, accessToken };
  }
}

const canonical = Astro.site ? new URL(Astro.url.pathname, Astro.site).href : undefined;
const nextStepPath = "/onboarding/garment";

const prefetch = await prefetchProfile(Astro.locals.supabase ?? null);
const shellProps = {
  profile: prefetch.profile,
  initialAccessToken: prefetch.accessToken,
  nextPath: nextStepPath,
};
---

<OnboardingLayout
  title="Vestilook — Dodaj swoją personę bazową"
  description="Prześlij zdjęcie referencyjne, aby rozpocząć personalizowane stylizacje w Vestilook."
  canonical={canonical}
>
  <div class="flex flex-1 flex-col items-center justify-center bg-gradient-to-br from-primary/10 via-background to-accent/20 px-6 py-12">
    <div class="relative z-10 flex w-full max-w-5xl flex-1 items-stretch justify-center">
      <OnboardingPersonaShell client:load profile={shellProps.profile} initialAccessToken={shellProps.initialAccessToken} nextPath={shellProps.nextPath} />
    </div>
  </div>
</OnboardingLayout>
